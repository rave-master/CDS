<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Travel Information Calendar</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body {
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      color: #f0f0f0;
    }
    #calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 12px; }
    .day {
      border: 1px solid #ccc; border-radius: .75rem; padding: 10px; min-height: 160px;
      background: rgba(255,255,255,.95); color: #111; position: relative; font-size: .95rem;
      transition: transform .2s;
    }
    .day:hover { transform: scale(1.02); }
    .date { font-weight: bold; margin-bottom: 6px; }
    .event {
      margin-top: 4px; padding: 4px; border-left: 4px solid #2563eb; border-radius: 4px;
      font-size: .875rem; cursor: pointer; word-break: break-word;
    }
    .weekday-header { font-weight: bold; text-align: center; color: #fff; margin-bottom: 6px; }
    @media(max-width:768px){
      .day { min-height: 120px; padding: 6px; font-size: .85rem; }
    }
  </style>
</head>
<body class="min-h-screen p-4">

  <!-- Google Search bar -->
  <div class="flex justify-center mb-3">
    <input id="google-search-input" type="text" placeholder="Search Google…" class="w-96 px-4 py-2 rounded-l-md border border-gray-300 text-black">
    <button onclick="searchGoogle()" class="bg-blue-600 text-white px-4 py-2 rounded-r-md hover:bg-blue-700">Search</button>
  </div>

  <!-- Name Filter -->
  <div class="flex justify-center mb-6">
    <input id="nameFilter" type="text" placeholder="🔍 Filter by name…" class="w-96 px-4 py-2 border border-gray-300 text-black rounded-md shadow" oninput="renderCalendar()">
  </div>

  <div class="max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-4">
      <button onclick="changeMonth(-1)" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">⬅ Previous</button>
      <h1 id="calendarTitle" class="text-3xl font-bold text-center text-white drop-shadow-lg">📅 Travel Calendar</h1>
      <button onclick="changeMonth(1)" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">Next ➡</button>
    </div>

    <!-- Weekday headers -->
    <div class="grid grid-cols-7 gap-2 mb-2">
      <div class="weekday-header">Sun</div><div class="weekday-header">Mon</div>
      <div class="weekday-header">Tue</div><div class="weekday-header">Wed</div>
      <div class="weekday-header">Thu</div><div class="weekday-header">Fri</div>
      <div class="weekday-header">Sat</div>
    </div>

    <!-- Calendar grid -->
    <div id="calendar"></div>
  </div>

  <!-- Modal -->
  <div id="infoModal" class="fixed inset-0 hidden bg-black bg-opacity-50 items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg w-96 text-black">
      <h2 class="text-xl font-bold mb-2">Travel Details</h2>
      <div id="modalContent"></div>
      <button onclick="closeModal()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded">Close</button>
    </div>
  </div>

  <!-- Main script -->
  <script type="module">
    const apiUrl = "https://script.google.com/macros/s/AKfycbzaYnbadkSXF4bGJNX-cb68yZIHu-zEWP41ewkik3SG1Ge15HDmrGjuKq2IcVgeMTE/exec";

    const calendar = document.getElementById("calendar");
    const calendarTitle = document.getElementById("calendarTitle");
    const nameFilterInput = document.getElementById("nameFilter");

    const purposeColors = {
      Training: "#c084fc", "Official Business": "#60a5fa", Monitoring: "#34d399",
      "Field Work": "#facc15", Meeting: "#f87171", Workshop: "#fbbf24",
      Seminar: "#fdba74", Inspection: "#fcd34d", Administrative: "#d1d5db"
    };

    let currentYear = 2025;
    let currentMonth = 6;
    let cachedData = [];

    const renderCalendar = () => {
      calendar.innerHTML = "";

      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      const firstDayIndex = new Date(currentYear, currentMonth, 1).getDay();
      const todayStr = new Date().toISOString().split("T")[0];
      const monthName = new Date(currentYear, currentMonth).toLocaleString("default", { month: "long" });
      calendarTitle.textContent = `📅 Travel Calendar – ${monthName} ${currentYear}`;

      for (let i = 0; i < firstDayIndex; i++) {
        const blank = document.createElement("div");
        blank.className = "day opacity-0 pointer-events-none";
        calendar.appendChild(blank);
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
        const cell = document.createElement("div");
        cell.className = "day";
        if (dateStr === todayStr) cell.classList.add("bg-yellow-100");
        const dateLabel = document.createElement("div");
        dateLabel.className = "date";
        dateLabel.textContent = dateStr;
        cell.appendChild(dateLabel);
        cell.dataset.date = dateStr;
        calendar.appendChild(cell);
      }

      const nameFilter = nameFilterInput.value.trim().toLowerCase();

      cachedData.forEach(entry => {
        const fromDate = new Date(entry["Date of Travel"]);
        const toDate = entry["Date of Return"] ? new Date(entry["Date of Return"]) : fromDate;
        if (isNaN(fromDate)) return;

        if (nameFilter && !entry["Name"].toLowerCase().includes(nameFilter)) return;

        const purpose = (entry["Purpose"] || "").trim();
        const color = purposeColors[purpose] || "#e0f2fe";

        for (let d = new Date(fromDate); d <= toDate; d.setDate(d.getDate() + 1)) {
          if (d.getFullYear() !== currentYear || d.getMonth() !== currentMonth) continue;
          const dStr = d.toISOString().split("T")[0];
          const cell = document.querySelector(`.day[data-date="${dStr}"]`);
          if (cell) {
            const div = document.createElement("div");
            div.className = "event";
            div.style.backgroundColor = color;
            div.textContent = entry["Name"];
            div.title = entry["Destination"] || "";
            div.onclick = () => openModal(entry);
            cell.appendChild(div);
          }
        }
      });
    };

    window.openModal = entry => {
      infoModal.classList.remove("hidden");
      infoModal.classList.add("flex");
      modalContent.innerHTML = `
        <p><strong>Name:</strong> ${entry.Name}</p>
        <p><strong>Destination:</strong> ${entry["Destination"] || ""}</p>
        <p><strong>Purpose:</strong> ${entry["Purpose"] || ""}</p>
        <p><strong>From:</strong> ${entry["Date of Travel"]}</p>
        <p><strong>To:</strong> ${entry["Date of Return"] || entry["Date of Travel"]}</p>
        <p><strong>Status/Remarks:</strong> ${entry["Status / Remarks (if there was a change of plan)"] || "N/A"}</p>`;
    };

    window.closeModal = () => {
      infoModal.classList.add("hidden");
      infoModal.classList.remove("flex");
    };

    window.changeMonth = step => {
      currentMonth += step;
      if (currentMonth < 0) { currentMonth = 11; currentYear--; }
      else if (currentMonth > 11) { currentMonth = 0; currentYear++; }
      renderCalendar();
    };

    fetch(apiUrl)
      .then(r => r.json())
      .then(data => {
        cachedData = data;
        renderCalendar();
      })
      .catch(err => console.error("Calendar data error:", err));
  </script>

  <!-- Background and Search -->
  <script>
    const backgroundImageURL = "https://images.unsplash.com/photo-1506744038136-46273834b3fb";
    document.addEventListener("DOMContentLoaded", () => {
      document.body.style.backgroundImage = `linear-gradient(to right,rgba(0,0,0,.6),rgba(0,0,0,.3)),url('${backgroundImageURL}')`;
    });
    function searchGoogle() {
      const q = document.getElementById("google-search-input").value;
      if (q) window.open(`https://www.google.com/search?q=${encodeURIComponent(q)}`, "_blank");
    }
  </script>
</body>
</html>
